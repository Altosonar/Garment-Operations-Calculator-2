<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Garment SAM Calculator</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
        }
        
        body {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            min-height: 100vh;
            padding: 12px;
            overflow-x: auto;
            overflow-y: auto;
        }
        
        .calculator-container {
            max-width: 746px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 12px 24px rgba(0,0,0,0.2);
            overflow: visible;
            display: flex;
            flex-direction: column;
            height: auto;
            min-height: 85vh;
        }
        
        .header {
            background: linear-gradient(to right, #2c3e50, #4a6491);
            color: white;
            padding: 16px;
            text-align: center;
            flex-shrink: 0;
        }
        
        .header h1 {
            margin: 0;
            font-size: 22px;
            font-weight: 700;
        }
        
        .header p {
            margin: 6px 0 0;
            opacity: 0.9;
            font-size: 14px;
            font-weight: 300;
        }
        
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
            overflow-x: auto;
            flex-shrink: 0;
        }
        
        .tab {
            padding: 14px 16px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #555;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            white-space: nowrap;
            flex: 1;
            text-align: center;
        }
        
        .tab:hover {
            background: rgba(0,0,0,0.05);
        }
        
        .tab.active {
            color: #3498db;
            border-bottom: 3px solid #3498db;
            background: white;
        }
        
        .tab-content {
            display: none;
            flex: 1;
            overflow: hidden;
            padding: 16px;
            min-height: 0;
        }
        
        .tab-content.active {
            display: flex;
            flex-direction: column;
        }
        
        .compact-input-row {
            display: grid;
            grid-template-columns: 2fr auto auto 96px 96px;
            gap: 12px;
            margin-bottom: 8px;
            padding: 10px 16px;
            border: 1px solid #eaeaea;
            border-radius: 6px;
            background: #f8f9fa;
            align-items: end;
            position: relative;
            z-index: 1;
        }
        
        .input-group-compact {
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        .input-group-compact label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #444;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.4px;
            white-space: nowrap;
        }
        
        .input-group-compact input, .input-group-compact select {
            width: 100%;
            padding: 10px 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            transition: border 0.3s;
            background: white;
            cursor: pointer;
            height: 40px;
        }
        
        .input-group-compact select:focus,
        .input-group-compact input:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        #garment-type-select option[disabled] {
            color: #7f8c8d;
            font-style: italic;
        }
        
        .btn {
            padding: 10px 14px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.3s;
            white-space: nowrap;
            height: 40px;
        }
        
        .btn-primary {
            background-color: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
        }
        
        .btn-secondary {
            background-color: #95a5a6;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #7f8c8d;
        }
        
        .btn-success {
            background-color: #2ecc71;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #27ae60;
        }
        
        .btn-warning {
            background-color: #f39c12;
            color: white;
        }
        
        .btn-warning:hover {
            background-color: #d68910;
        }
        
        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-pdf {
            background-color: #e74c3c;
            color: white;
        }
        
        .btn-pdf:hover {
            background-color: #c0392b;
        }
        
        .btn-layout {
            background-color: #9b59b6;
            color: white;
        }
        
        .btn-layout:hover {
            background-color: #8e44ad;
        }
        
        .layout-toggle-btn {
            padding: 10px 14px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.3s;
            white-space: nowrap;
            height: 40px;
            background-color: #9b59b6;
            color: white;
            min-width: 112px;
        }
        
        .layout-toggle-btn:hover {
            background-color: #8e44ad;
        }
        
        .layout-toggle-btn i {
            transition: transform 0.3s;
        }
        
        .layout-toggle-btn.vertical i {
            transform: rotate(0deg);
        }
        
        .layout-toggle-btn.horizontal i {
            transform: rotate(90deg);
        }
        
        .label-with-tooltip {
            display: flex;
            align-items: center;
            gap: 3px;
            margin-bottom: 5px;
            position: relative;
        }
        
        .tooltip-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 14px;
            height: 14px;
            background-color: #3498db;
            color: white;
            border-radius: 50%;
            font-size: 9px;
            font-weight: bold;
            cursor: help;
            position: relative;
            user-select: none;
            transition: background-color 0.2s;
            z-index: 100;
            flex-shrink: 0;
        }
        
        .tooltip-icon:hover {
            background-color: #2980b9;
        }
        
        .tooltip-text {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            z-index: 1000;
            background-color: #2c3e50;
            color: white;
            padding: 7px 9px;
            border-radius: 5px;
            font-size: 11px;
            font-weight: normal;
            width: 176px;
            text-align: left;
            line-height: 1.35;
            box-shadow: 0 3px 10px rgba(0,0,0,0.15);
            transition: opacity 0.3s, visibility 0.3s;
            pointer-events: none;
            bottom: 100%;
            left: 0;
            transform: translateX(0);
            margin-bottom: 6px;
        }
        
        .compact-input-row .tooltip-text {
            bottom: 100%;
            left: 0;
            transform: translateX(0);
            margin-bottom: 6px;
        }
        
        .compact-input-row .tooltip-icon:nth-child(1) .tooltip-text,
        .compact-input-row .tooltip-icon:nth-child(2) .tooltip-text {
            left: 0;
        }
        
        .compact-input-row .tooltip-icon:nth-last-child(-n+2) .tooltip-text {
            left: auto;
            right: 0;
        }
        
        .tooltip-text::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 12px;
            margin-left: -4px;
            border-width: 4px;
            border-style: solid;
            border-color: #2c3e50 transparent transparent transparent;
        }
        
        .compact-input-row .tooltip-icon:nth-last-child(-n+2) .tooltip-text::after {
            left: auto;
            right: 12px;
        }
        
        .tooltip-icon:hover .tooltip-text,
        .tooltip-icon:focus .tooltip-text,
        .tooltip-icon.active .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        @media (max-width: 768px) {
            .tooltip-text {
                width: 90vw;
                max-width: 190px;
                font-size: 10px;
                padding: 6px 7px;
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                bottom: auto;
                margin: 0;
                z-index: 9999;
            }
            
            .tooltip-text::after {
                display: none;
            }
            
            .tooltip-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                z-index: 9998;
            }
            
            .tooltip-icon.active + .tooltip-overlay {
                display: block;
            }
            
            .tooltip-icon:active .tooltip-text,
            .tooltip-icon.active .tooltip-text {
                visibility: visible;
                opacity: 1;
            }
        }
        
        /* Operations Tabs - NEW */
        .operation-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
            overflow-x: auto;
            flex-shrink: 0;
            padding: 0 8px;
            min-height: 44px;
        }
        
        .operation-tab {
            padding: 10px 16px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            color: #555;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 6px;
            position: relative;
        }
        
        .operation-tab:hover {
            background: rgba(0,0,0,0.05);
        }
        
        .operation-tab.active {
            color: #3498db;
            border-bottom: 3px solid #3498db;
            background: white;
        }
        
        .operation-tab-close {
            background: none;
            border: none;
            color: #999;
            font-size: 12px;
            cursor: pointer;
            padding: 0;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }
        
        .operation-tab-close:hover {
            background: #e74c3c;
            color: white;
        }
        
        /* Removed the .add-operation-tab style as we removed the "+ Add" tab */
        
        .operations-container-wrapper {
            flex: 1;
            overflow: visible;
            margin-bottom: 16px;
            border: 1px solid #eaeaea;
            border-radius: 6px;
            background: #fafafa;
            min-height: 320px;
            position: relative;
            z-index: 1;
        }
        
        /* UPDATED: Operations Container - Show only one operation at a time in vertical layout */
        .operations-container.vertical {
            display: block;
            padding: 16px;
            overflow-x: visible;
            overflow-y: auto;
            height: auto;
            align-items: stretch;
        }
        
        .operations-container.horizontal {
            display: flex;
            flex-direction: row;
            gap: 16px;
            padding: 16px;
            overflow-x: auto;
            overflow-y: hidden;
            height: auto;
            align-items: flex-start;
            flex-wrap: nowrap;
            min-height: 384px;
        }
        
        .operations-container.horizontal::-webkit-scrollbar {
            height: 6px;
        }
        
        .operations-container.horizontal::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 8px;
        }
        
        .operations-container.horizontal::-webkit-scrollbar-thumb {
            background: #3498db;
            border-radius: 8px;
        }
        
        /* Operation Card - UPDATED for single operation view */
        .operations-container.vertical .operation-card {
            background: white;
            border-radius: 8px;
            padding: 16px;
            border: 1px solid #e0e0e0;
            min-width: 0;
            max-width: 100%;
            height: auto;
            display: flex;
            flex-direction: column;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s;
            overflow: visible;
            width: 100%;
            position: relative;
        }
        
        .operations-container.horizontal .operation-card {
            background: white;
            border-radius: 8px;
            padding: 16px;
            border: 1px solid #e0e0e0;
            min-width: 304px;
            max-width: 304px;
            height: 448px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s;
            overflow: visible;
            flex-shrink: 0;
        }
        
        .operation-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .operation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px dashed #ddd;
            flex-shrink: 0;
        }
        
        .operation-number-btn {
            background-color: #000000;
            color: white;
            width: auto;
            min-width: 48px;
            height: 29px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
            padding: 0 10px;
            border: 2px solid #000000;
            font-family: 'Courier New', monospace;
            letter-spacing: 0.4px;
            text-transform: uppercase;
        }
        
        .operation-header-buttons {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        /* New button styles for add/remove operations in the form */
        .btn-add-operation {
            background-color: #2ecc71;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 12px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            transition: background-color 0.2s;
            min-width: 80px;
        }
        
        .btn-add-operation:hover {
            background-color: #27ae60;
        }
        
        .btn-remove-operation {
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 12px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            transition: background-color 0.2s;
            min-width: 80px;
        }
        
        .btn-remove-operation:hover {
            background-color: #c0392b;
        }
        
        /* Operation Navigation Controls - NEW */
        .operation-nav-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 16px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #eaeaea;
        }
        
        .operation-nav-info {
            font-size: 13px;
            color: #555;
            font-weight: 600;
        }
        
        .operation-nav-buttons {
            display: flex;
            gap: 8px;
        }
        
        .nav-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s;
            background-color: #3498db;
            color: white;
        }
        
        .nav-btn:hover {
            background-color: #2980b9;
        }
        
        .nav-btn:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        
        .nav-btn-prev {
            background-color: #95a5a6;
        }
        
        .nav-btn-prev:hover:not(:disabled) {
            background-color: #7f8c8d;
        }
        
        .operation-inputs {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 12px;
            flex: 1;
            overflow-y: visible;
            padding-right: 0;
        }
        
        .input-group {
            margin-bottom: 0;
            position: relative;
        }
        
        .input-group.full-width {
            grid-column: 1 / -1;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #444;
            font-size: 12px;
        }
        
        .input-group label.required::after {
            content: " *";
            color: #e74c3c;
        }
        
        input, select {
            width: 100%;
            padding: 8px 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 13px;
            transition: border 0.3s;
        }
        
        input:focus, select:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .input-hint {
            font-size: 10px;
            color: #7f8c8d;
            margin-top: 4px;
            font-style: italic;
        }
        
        .result-box {
            background-color: #f8f9fa;
            border-radius: 6px;
            padding: 12px;
            margin-top: auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            border: 1px solid #e9ecef;
            flex-shrink: 0;
        }
        
        .result-item {
            text-align: center;
            padding: 8px;
        }
        
        .result-value {
            font-size: 16px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 4px;
        }
        
        .result-label {
            font-size: 10px;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 0.4px;
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
            padding-top: 0;
            border-top: 1px solid #eaeaea;
        }
        
        .summary-section {
            background: #2c3e50;
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 16px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .summary-item {
            text-align: center;
            padding: 12px;
        }
        
        .summary-value {
            font-size: 26px;
            font-weight: 800;
            margin-bottom: 4px;
            font-family: 'Arial', sans-serif;
        }
        
        .summary-label {
            font-size: 10px;
            color: #bdc3c7;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin-bottom: 4px;
        }
        
        .summary-subtext {
            font-size: 9px;
            color: #95a5a6;
            opacity: 0.8;
        }
        
        .total-sam { color: #f39c12; }
        .target-pcs-hr { color: #2ecc71; }
        .daily-target { color: #3498db; }
        .pitch-time { color: #9b59b6; }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 16px;
        }
        
        .dashboard-card {
            background: white;
            border-radius: 8px;
            padding: 16px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .dashboard-card h3 {
            color: #2c3e50;
            margin-bottom: 12px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }
        
        .kpi-item {
            text-align: center;
            padding: 12px;
            background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);
            border-radius: 6px;
            color: white;
        }
        
        .kpi-value {
            font-size: 20px;
            font-weight: 800;
            margin-bottom: 4px;
        }
        
        .kpi-label {
            font-size: 10px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 0.4px;
        }
        
        .recommendation-list {
            list-style: none;
            padding: 0;
        }
        
        .recommendation-list li {
            padding: 6px 0;
            border-bottom: 1px dashed #eee;
            color: #555;
            font-size: 12px;
            line-height: 1.5;
        }
        
        .recommendation-list li:last-child {
            border-bottom: none;
        }
        
        .recommendation-list li:before {
            content: "‚Ä¢";
            color: #3498db;
            font-weight: bold;
            display: inline-block;
            width: 1em;
            margin-left: -1em;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 16px;
        }
        
        .info-card {
            background: white;
            border-radius: 8px;
            padding: 16px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .info-card h3 {
            color: #2c3e50;
            margin-bottom: 12px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .info-card ul {
            padding-left: 16px;
            margin-top: 8px;
        }
        
        .info-card li {
            margin-bottom: 6px;
            color: #555;
            line-height: 1.5;
        }
        
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }
        
        .modal-content {
            background: white;
            border-radius: 10px;
            padding: 24px;
            max-width: 720px;
            width: 100%;
            box-shadow: 0 16px 32px rgba(0,0,0,0.3);
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-title {
            font-size: 20px;
            color: #2c3e50;
            margin-bottom: 12px;
            font-weight: 700;
        }
        
        .modal-message {
            font-size: 14px;
            color: #555;
            margin-bottom: 20px;
            line-height: 1.6;
        }
        
        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 16px;
        }
        
        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 96px;
        }
        
        .modal-btn-confirm {
            background-color: #3498db;
            color: white;
        }
        
        .modal-btn-confirm:hover {
            background-color: #2980b9;
        }
        
        .modal-btn-cancel {
            background-color: #95a5a6;
            color: white;
        }
        
        .modal-btn-cancel:hover {
            background-color: #7f8c8d;
        }
        
        .operations-library {
            margin-bottom: 16px;
        }
        
        .library-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .selected-count {
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }
        
        .library-filter {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .category-section {
            margin-bottom: 20px;
            background: white;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .category-title {
            font-size: 16px;
            font-weight: 700;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .category-icon {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
        }
        
        .select-all-category {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #555;
            cursor: pointer;
        }
        
        .operations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 10px;
            margin-top: 12px;
        }
        
        .library-operation {
            background: white;
            border: 2px solid #e8e8e8;
            border-radius: 6px;
            padding: 12px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .library-operation:hover {
            border-color: #3498db;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.15);
        }
        
        .library-operation.selected {
            background: #f0f7ff;
            border-color: #3498db;
        }
        
        .operation-checkbox {
            width: 18px;
            height: 18px;
            margin-top: 2px;
            cursor: pointer;
            accent-color: #3498db;
        }
        
        .operation-content {
            flex: 1;
        }
        
        .operation-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 6px;
            font-size: 13px;
            line-height: 1.4;
        }
        
        .operation-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
            margin-top: 8px;
        }
        
        .detail-item {
            background: #f8f9fa;
            padding: 5px 6px;
            border-radius: 3px;
            text-align: center;
        }
        
        .detail-value {
            font-size: 11px;
            font-weight: 700;
            color: #2c3e50;
        }
        
        .detail-label {
            font-size: 9px;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 0.2px;
            margin-top: 2px;
        }
        
        .operation-type {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            display: inline-block;
            margin-top: 4px;
        }
        
        .top-wear { background: #3498db; }
        .bottom-wear { background: #2ecc71; }
        .dress { background: #9b59b6; }
        .jacket { background: #e74c3c; }
        .underwear { background: #f39c12; }
        .finishing { background: #95a5a6; }
        
        /* Updated responsive breakpoints */
        @media (min-width: 768px) and (max-width: 1199px) {
            .dashboard-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .operations-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
            
            .summary-section {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .compact-input-row {
                grid-template-columns: repeat(5, 1fr);
                gap: 8px;
            }
        }
        
        @media (max-width: 767px) {
            .calculator-container {
                height: auto;
                min-height: 100vh;
            }
            
            .compact-input-row {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .kpi-grid {
                grid-template-columns: 1fr;
            }
            
            .operations-container.horizontal .operation-card {
                min-width: 256px;
                max-width: 256px;
                height: 480px;
            }
            
            .library-filter {
                grid-template-columns: 1fr;
            }
            
            .operations-grid {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .modal-content {
                padding: 16px;
            }
            
            .summary-section {
                grid-template-columns: 1fr;
            }
            
            .layout-toggle-btn {
                width: 100%;
            }
            
            .operation-header-buttons {
                flex-direction: column;
                gap: 4px;
            }
            
            .btn-add-operation,
            .btn-remove-operation {
                width: 100%;
                border-radius: 5px;
                height: 32px;
            }
            
            .operation-inputs {
                grid-template-columns: 1fr;
            }
            
            .operation-nav-controls {
                flex-direction: column;
                gap: 12px;
            }
            
            .operation-nav-buttons {
                width: 100%;
            }
            
            .nav-btn {
                flex: 1;
                justify-content: center;
            }
        }
        
        @media (max-width: 480px) {
            .header h1 {
                font-size: 18px;
            }
            
            .header p {
                font-size: 12px;
            }
            
            .tab {
                padding: 10px 12px;
                font-size: 12px;
            }
            
            .operation-details {
                grid-template-columns: 1fr 1fr;
            }
            
            .modal-buttons {
                flex-direction: column;
            }
            
            .modal-btn {
                width: 100%;
            }
            
            .summary-value {
                font-size: 20px;
            }
            
            .compact-input-row label {
                font-size: 9px;
            }
            
            .compact-input-row input,
            .compact-input-row select {
                font-size: 11px;
                padding: 8px 6px;
            }
            
            .operations-container.horizontal .operation-card {
                min-width: 224px;
                max-width: 224px;
                height: 496px;
            }
            
            .operation-number-btn {
                min-width: 40px;
                height: 26px;
                font-size: 10px;
                padding: 0 6px;
            }
        }
    </style>
</head>
<body>
    <!-- Custom Modal -->
    <div id="customModal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="modal-title" id="modalTitle">Notification</h3>
            <p class="modal-message" id="modalMessage">This is a modal message.</p>
            <div class="modal-buttons">
                <button id="modalConfirmBtn" class="modal-btn modal-btn-confirm">OK</button>
                <button id="modalCancelBtn" class="modal-btn modal-btn-cancel" style="display: none;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Operations Library Modal -->
    <div id="operationsLibraryModal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="modal-title">üìö Garment Operations Library</h3>
            <p class="modal-message">Browse and select operations to add to your garment. Operations are organized by garment type for easy selection.</p>
            
            <div class="library-controls">
                <div class="selected-count" id="selectedCount">0 operations selected</div>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-danger" onclick="clearAllSelections()">
                        <i class="fas fa-times"></i> Clear All
                    </button>
                    <button class="btn btn-success" onclick="addSelectedOperations()">
                        <i class="fas fa-plus-circle"></i> Add Selected
                    </button>
                </div>
            </div>
            
            <div class="library-filter">
                <div>
                    <label>Search Operations:</label>
                    <input type="text" id="operationSearch" placeholder="Type operation name..." onkeyup="filterOperations()">
                </div>
                <div>
                    <label>Filter by Type:</label>
                    <select id="garmentFilter" onchange="filterByGarmentType()">
                        <option value="all">All Garment Types</option>
                        <option value="t-shirt">T-Shirt</option>
                        <option value="dress-shirt">Dress Shirt</option>
                        <option value="pants">Pants</option>
                        <option value="dress">Dress</option>
                        <option value="jacket">Jacket/Outerwear</option>
                        <option value="underwear">Underwear/Bikini</option>
                    </select>
                </div>
            </div>
            
            <div class="operations-library" id="operations-library">
                <!-- Categories will be loaded here -->
            </div>
            
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" onclick="hideOperationsLibrary()">Close</button>
            </div>
        </div>
    </div>

    <!-- Main Calculator -->
    <div class="calculator-container">
        <div class="header">
            <h1>üëï Garment SAM Calculator</h1>
            <p>Professional Production Planning Tool</p>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('calculator')">üßÆ Calculator</button>
            <button class="tab" onclick="switchTab('dashboard')">üìä Dashboard</button>
            <button class="tab" onclick="switchTab('info')">‚ÑπÔ∏è Info</button>
        </div>
        
        <!-- Calculator Tab -->
        <div id="calculator" class="tab-content active">
            <!-- COMPACT SINGLE ROW: Garment Type, Load Preset, Save Type, SHIFT TIME, TOTAL OPERATORS -->
            <div class="compact-input-row">
                <!-- Garment Type -->
                <div class="input-group-compact">
                    <div class="label-with-tooltip">
                        <div class="tooltip-icon" tabindex="0">
                            i
                            <div class="tooltip-text">
                                <strong>Garment Type</strong><br>
                                Select the type of garment you're calculating SAM for. Common types include T-Shirts, Pants, Jackets, etc. This determines preset operations when loading.
                            </div>
                        </div>
                        <label for="garment-type-select">Garment Type</label>
                    </div>
                    <select id="garment-type-select" onchange="setGarmentTypeFromDropdown()">
                        <option value="" disabled selected>Select Garment Type</option>
                        <option value="T-Shirt">T-Shirt</option>
                        <option value="Dress Shirt">Dress Shirt</option>
                        <option value="Pants">Pants</option>
                        <option value="Jacket">Jacket</option>
                        <option value="Dress">Dress</option>
                        <option value="Bikini">Bikini</option>
                        <option value="Underwear">Underwear</option>
                        <option value="Custom Garment">Custom Garment</option>
                    </select>
                </div>
                
                <!-- Load Preset Button -->
                <button type="button" class="btn btn-secondary" onclick="loadPresetOperations()">
                    <i class="fas fa-download"></i> Load Preset
                </button>
                
                <!-- Save Type Button -->
                <button type="button" class="btn btn-primary" onclick="saveGarmentType()">
                    <i class="fas fa-save"></i> Save Type
                </button>
                
                <!-- SHIFT TIME -->
                <div class="input-group-compact">
                    <div class="label-with-tooltip">
                        <div class="tooltip-icon" tabindex="0">
                            i
                            <div class="tooltip-text">
                                <strong>Shift Time (Minutes)</strong><br>
                                Total working minutes in a shift. Standard is 480 minutes (8 hours). Used to calculate daily production targets and capacity.
                            </div>
                        </div>
                        <label for="shift-time">SHIFT TIME (MIN)</label>
                    </div>
                    <input type="number" id="shift-time" value="480" min="1" max="1440" oninput="calculateAllOperations()">
                </div>
                
                <!-- TOTAL OPERATORS -->
                <div class="input-group-compact">
                    <div class="label-with-tooltip">
                        <div class="tooltip-icon" tabindex="0">
                            i
                            <div class="tooltip-text">
                                <strong>Total Operators</strong><br>
                                Number of operators working in the production line. Used to calculate pitch time and total available minutes for production planning.
                            </div>
                        </div>
                        <label for="total-operators">TOTAL OPERATORS</label>
                    </div>
                    <input type="number" id="total-operators" value="10" min="1" max="1000" oninput="calculateAllOperations()">
                </div>
            </div>
            
            <!-- Operation Tabs - Updated: No "+ Add" tab -->
            <div class="operation-tabs" id="operation-tabs">
                <!-- Operation tabs will be dynamically added here -->
            </div>
            
            <div class="operations-container-wrapper">
                <div class="operations-container vertical" id="operations-container">
                    <!-- Operations will be dynamically added here -->
                </div>
            </div>
            
            <!-- Operation Navigation Controls - NEW -->
            <div class="operation-nav-controls" id="operation-nav-controls" style="display: none;">
                <div class="operation-nav-info">
                    Operation <span id="current-op-number">1</span> of <span id="total-ops-count">1</span>
                </div>
                <div class="operation-nav-buttons">
                    <button class="nav-btn nav-btn-prev" id="prev-op-btn" onclick="switchOperation(-1)">
                        <i class="fas fa-chevron-left"></i> Previous
                    </button>
                    <button class="nav-btn" id="next-op-btn" onclick="switchOperation(1)">
                        Next <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
            
            <div class="controls">
                <button type="button" class="layout-toggle-btn vertical" id="layoutToggleBtn" onclick="toggleLayout()">
                    <i class="fas fa-list"></i> Switch to Horizontal
                </button>
                
                <button type="button" class="btn btn-success" onclick="showOperationsLibrary()">
                    <i class="fas fa-book"></i> Operations Library
                </button>
                <button type="button" class="btn btn-success" onclick="calculateAllOperations()">
                    <i class="fas fa-calculator"></i> Calculate All
                </button>
                <button type="button" class="btn btn-pdf" onclick="generatePDFReport()">
                    <i class="fas fa-file-pdf"></i> PDF Report
                </button>
                <button type="button" class="btn btn-warning" onclick="exportToExcel()">
                    <i class="fas fa-file-excel"></i> Export
                </button>
                <button type="button" class="btn btn-secondary" onclick="clearAllOperations()">
                    <i class="fas fa-eraser"></i> Clear All
                </button>
            </div>
            
            <!-- Enhanced Summary Section -->
            <div class="summary-section" id="summary-section" style="display: none;">
                <div class="summary-item">
                    <div class="summary-value total-sam" id="total-sam">0.00</div>
                    <div class="summary-label">TOTAL GARMENT SAM</div>
                    <div class="summary-subtext">Minutes/Garment</div>
                </div>
                
                <div class="summary-item">
                    <div class="summary-value target-pcs-hr" id="target-pcs-hr">0</div>
                    <div class="summary-label">TARGET PCS/HR</div>
                    <div class="summary-subtext">At Current Efficiency</div>
                </div>
                
                <div class="summary-item">
                    <div class="summary-value daily-target" id="daily-target">0</div>
                    <div class="summary-label">DAILY TARGET</div>
                    <div class="summary-subtext">Pieces/Shift</div>
                </div>
                
                <div class="summary-item">
                    <div class="summary-value pitch-time" id="pitch-time">0.00</div>
                    <div class="summary-label">PITCH TIME</div>
                    <div class="summary-subtext">Target Pace (Min)</div>
                </div>
            </div>
        </div>
        
        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content">
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <h3><i class="fas fa-chart-bar"></i> Production Summary</h3>
                    <div class="kpi-grid">
                        <div class="kpi-item">
                            <div class="kpi-value" id="dashboard-total-sam">0.00</div>
                            <div class="kpi-label">Total SAM</div>
                        </div>
                        <div class="kpi-item">
                            <div class="kpi-value" id="dashboard-pieces-hour">0</div>
                            <div class="kpi-label">Pieces/Hour</div>
                        </div>
                        <div class="kpi-item">
                            <div class="kpi-value" id="dashboard-daily-target">0</div>
                            <div class="kpi-label">Daily Target</div>
                        </div>
                    </div>
                </div>
                
                <div class="dashboard-card">
                    <h3><i class="fas fa-lightbulb"></i> Recommendations</h3>
                    <ul class="recommendation-list">
                        <li>Add allowances for machine setup and thread changes</li>
                        <li>Consider bundle handling time (typically 5-10%)</li>
                        <li>Add personal and fatigue allowances (15-20%)</li>
                        <li>Review cycle times for potential improvements</li>
                        <li>Balance workload across operations for smoother flow</li>
                    </ul>
                </div>
                
                <div class="dashboard-card">
                    <h3><i class="fas fa-chart-line"></i> Performance Targets</h3>
                    <ul class="recommendation-list">
                        <li>Target SAM: &lt; 15 minutes for basic garments</li>
                        <li>Target efficiency: 80-95% performance rating</li>
                        <li>Total allowances: 20-30% for most operations</li>
                        <li>Cycle time reduction of 0.1 min can increase output by 6-8%</li>
                        <li>Aim for 85% efficiency on complex operations</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- Info Tab -->
        <div id="info" class="tab-content">
            <div class="info-grid">
                <div class="info-card">
                    <h3><i class="fas fa-info-circle"></i> About Garment Types</h3>
                    <p>You can type any garment type in the input field. Common examples include:</p>
                    <ul>
                        <li><strong>T-Shirt:</strong> Basic operations like hemming, sleeve attachment, side seams</li>
                        <li><strong>Dress Shirt:</strong> More complex operations like collar making, cuff attachment, placket</li>
                        <li><strong>Pants:</strong> Operations for waistband, fly, inseam, and hemming</li>
                        <li><strong>Jacket:</strong> Complex operations including lining, pockets, and interlining</li>
                        <li><strong>Dress:</strong> Varied operations depending on style with finishing details</li>
                        <li><strong>Underwear/Bikini:</strong> Elastic attachment, gusset sewing, and specialized finishing</li>
                    </ul>
                </div>
                
                <div class="info-card">
                    <h3><i class="fas fa-clipboard-list"></i> Standard Allowances</h3>
                    <ul>
                        <li><strong>Bundle Allowance (5-10%):</strong> Time for handling work bundles, thread changes, material preparation.</li>
                        <li><strong>Personal Allowance (5%):</strong> Time for personal needs like drinking water, using restroom.</li>
                        <li><strong>Fatigue Allowance (5-10%):</strong> Time to recover from physical and mental fatigue.</li>
                        <li><strong>Machine Delay Allowance (5%):</strong> Time for unavoidable delays like machine adjustments, maintenance.</li>
                    </ul>
                    <p><strong>Total allowances typically range from 15% to 30% depending on work conditions and garment complexity.</strong></p>
                </div>
                
                <div class="info-card">
                    <h3><i class="fas fa-calculator"></i> How to Use</h3>
                    <ol>
                        <li>Enter your garment type or select from common types</li>
                        <li>Click "Load Preset" to get typical operations for that garment type</li>
                        <li>Use the "Operations Library" to add specific operations</li>
                        <li>Select multiple operations using checkboxes in the library</li>
                        <li>Adjust cycle times, performance ratings, and allowances as needed</li>
                        <li>Click "Calculate All" to see results</li>
                        <li>View the Dashboard for recommendations</li>
                    </ol>
                </div>
                
                <div class="info-card">
                    <h3><i class="fas fa-book"></i> Operations Library</h3>
                    <p>The operations library contains pre-defined garment operations categorized by garment type. Each operation includes recommended cycle times based on industry standards.</p>
                    <p>Library categories:</p>
                    <ul>
                        <li><strong>Top-Wear:</strong> Shirts, T-Shirts, Blouses</li>
                        <li><strong>Bottom-Wear:</strong> Pants, Jeans, Skirts</li>
                        <li><strong>Dresses:</strong> Various dress styles</li>
                        <li><strong>Outerwear:</strong> Jackets, Coats, Blazers</li>
                        <li><strong>Underwear & Bikinis:</strong> Bras, Panties, Swimwear</li>
                        <li><strong>Finishing:</strong> Universal finishing operations</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Garment type presets
        const garmentPresets = {
            'T-Shirt': [
                { name: 'Hemming', cycleTime: 0.25, unit: 'minutes', rating: 100, allowance: 20, targetEff: 70, machineType: 'SNLS' },
                { name: 'Sleeve Attachment', cycleTime: 0.40, unit: 'minutes', rating: 100, allowance: 25, targetEff: 70, machineType: 'SNLS' },
                { name: 'Side Seams', cycleTime: 0.35, unit: 'minutes', rating: 100, allowance: 20, targetEff: 70, machineType: 'SNLS' },
                { name: 'Neck Binding', cycleTime: 0.50, unit: 'minutes', rating: 100, allowance: 30, targetEff: 70, machineType: 'SNLS' }
            ],
            'Dress Shirt': [
                { name: 'Collar Making', cycleTime: 1.20, unit: 'minutes', rating: 100, allowance: 25, targetEff: 70, machineType: 'SNLS' },
                { name: 'Cuff Making', cycleTime: 0.80, unit: 'minutes', rating: 100, allowance: 25, targetEff: 70, machineType: 'SNLS' },
                { name: 'Placket Attachment', cycleTime: 0.60, unit: 'minutes', rating: 100, allowance: 20, targetEff: 70, machineType: 'SNLS' },
                { name: 'Sleeve Attachment', cycleTime: 0.45, unit: 'minutes', rating: 100, allowance: 20, targetEff: 70, machineType: 'SNLS' }
            ],
            'Pants': [
                { name: 'Waistband Making', cycleTime: 0.90, unit: 'minutes', rating: 100, allowance: 25, targetEff: 70, machineType: 'SNLS' },
                { name: 'Fly Making', cycleTime: 1.10, unit: 'minutes', rating: 100, allowance: 30, targetEff: 70, machineType: 'SNLS' },
                { name: 'Inseam Stitching', cycleTime: 0.60, unit: 'minutes', rating: 100, allowance: 20, targetEff: 70, machineType: 'SNLS' },
                { name: 'Side Seams', cycleTime: 0.50, unit: 'minutes', rating: 100, allowance: 20, targetEff: 70, machineType: 'SNLS' }
            ],
            'Jacket': [
                { name: 'Front Panel Assembly', cycleTime: 1.50, unit: 'minutes', rating: 100, allowance: 30, targetEff: 70, machineType: 'SNLS' },
                { name: 'Lining Preparation', cycleTime: 1.20, unit: 'minutes', rating: 100, allowance: 25, targetEff: 70, machineType: 'SNLS' },
                { name: 'Pocket Making', cycleTime: 0.90, unit: 'minutes', rating: 100, allowance: 25, targetEff: 70, machineType: 'SNLS' },
                { name: 'Sleeve Setting', cycleTime: 1.00, unit: 'minutes', rating: 100, allowance: 30, targetEff: 70, machineType: 'SNLS' }
            ],
            'Dress': [
                { name: 'Bodice Assembly', cycleTime: 1.00, unit: 'minutes', rating: 100, allowance: 25, targetEff: 70, machineType: 'SNLS' },
                { name: 'Skirt Assembly', cycleTime: 0.80, unit: 'minutes', rating: 100, allowance: 25, targetEff: 70, machineType: 'SNLS' },
                { name: 'Zipper Attachment', cycleTime: 0.60, unit: 'minutes', rating: 100, allowance: 20, targetEff: 70, machineType: 'SNLS' },
                { name: 'Sleeve Setting', cycleTime: 0.50, unit: 'minutes', rating: 100, allowance: 20, targetEff: 70, machineType: 'SNLS' }
            ],
            'Underwear': [
                { name: 'Elastic Attachment', cycleTime: 0.30, unit: 'minutes', rating: 100, allowance: 20, targetEff: 70, machineType: 'SNLS' },
                { name: 'Gusset Sewing', cycleTime: 0.25, unit: 'minutes', rating: 100, allowance: 20, targetEff: 70, machineType: 'SNLS' },
                { name: 'Side Seams', cycleTime: 0.15, unit: 'minutes', rating: 100, allowance: 15, targetEff: 70, machineType: 'SNLS' },
                { name: 'Label Attachment', cycleTime: 0.10, unit: 'minutes', rating: 100, allowance: 10, targetEff: 70, machineType: 'SNLS' }
            ],
            'Bikini': [
                { name: 'Cup Assembly', cycleTime: 0.45, unit: 'minutes', rating: 100, allowance: 25, targetEff: 70, machineType: 'SNLS' },
                { name: 'Elastic Attachment', cycleTime: 0.35, unit: 'minutes', rating: 100, allowance: 20, targetEff: 70, machineType: 'SNLS' },
                { name: 'Side Seams', cycleTime: 0.20, unit: 'minutes', rating: 100, allowance: 15, targetEff: 70, machineType: 'SNLS' },
                { name: 'Hook Attachment', cycleTime: 0.25, unit: 'minutes', rating: 100, allowance: 20, targetEff: 70, machineType: 'SNLS' }
            ],
            'Custom Garment': [
                { name: 'Operation 1', cycleTime: 0.50, unit: 'minutes', rating: 100, allowance: 20, targetEff: 70, machineType: 'SNLS' },
                { name: 'Operation 2', cycleTime: 0.75, unit: 'minutes', rating: 100, allowance: 25, targetEff: 70, machineType: 'SNLS' },
                { name: 'Operation 3', cycleTime: 0.60, unit: 'minutes', rating: 100, allowance: 20, targetEff: 70, machineType: 'SNLS' },
                { name: 'Operation 4', cycleTime: 0.45, unit: 'minutes', rating: 100, allowance: 15, targetEff: 70, machineType: 'SNLS' }
            ]
        };

        // Operations Library
        const operationsLibrary = {
            'Top-Wear (Shirts, T-Shirts)': {
                icon: 'üëï',
                color: '#3498db',
                type: 'top-wear',
                operations: [
                    { name: 'Placket Attachment', cycleTime: 1.50, unit: 'minutes', rating: 100, allowance: 25, targetEff: 70, machineType: 'SNLS', types: ['t-shirt', 'dress-shirt'] },
                    { name: 'Pocket Hem & Attach', cycleTime: 0.75, unit: 'minutes', rating: 100, allowance: 20, targetEff: 70, machineType: 'SNLS', types: ['t-shirt', 'dress-shirt'] },
                    { name: 'Collar Band Prep', cycleTime: 1.20, unit: 'minutes', rating: 100, allowance: 25, targetEff: 70, machineType: 'SNLS', types: ['dress-shirt'] },
                    { name: 'Collar Topstitching', cycleTime: 0.90, unit: 'minutes', rating: 100, allowance: 20, targetEff: 70, machineType: 'SNLS', types: ['dress-shirt'] },
                    { name: 'Sleeve Placket', cycleTime: 0.70, unit: 'minutes', rating: 100, allowance: 20, targetEff: 70, machineType: 'SNLS', types: ['dress-shirt'] },
                    { name: 'Cuff Preparation', cycleTime: 1.10, unit: 'minutes', rating: 100, allowance: 25, targetEff: 70, machineType: 'SNLS', types: ['dress-shirt'] },
                    { name: 'Shoulder Joining', cycleTime: 0.50, unit: 'minutes', rating: 100, allowance: 20, targetEff: 70, machineType: 'SNLS', types: ['t-shirt', 'dress-shirt'] },
                    { name: 'Sleeve Attachment', cycleTime: 1.30, unit: 'minutes', rating: 100, allowance: 25, targetEff: 70, machineType: 'SNLS', types: ['t-shirt', 'dress-shirt'] }
                ]
            },
            'Bottom-Wear (Pants, Skirts)': {
                icon: 'üëñ',
                color: '#2ecc71',
                type: 'bottom-wear',
                operations: [
                    { name: 'Side Pocket Prep', cycleTime: 1.20, unit: 'minutes', rating: 100, allowance: 25, targetEff: 70, machineType: 'SNLS', types: ['pants'] },
                    { name: 'Fly Zip Attachment', cycleTime: 2.00, unit: 'minutes', rating: 100, allowance: 30, targetEff: 70, machineType: 'SNLS', types: ['pants'] },
                    { name: 'Back Pocket', cycleTime: 1.50, unit: 'minutes', rating: 100, allowance: 25, targetEff: 70, machineType: 'SNLS', types: ['pants'] },
                    { name: 'Waistband Joining', cycleTime: 1.50, unit: 'minutes', rating: 100, allowance: 25, targetEff: 70, machineType: 'SNLS', types: ['pants', 'skirt'] },
                    { name: 'Inseam Joining', cycleTime: 1.00, unit: 'minutes', rating: 100, allowance: 20, targetEff: 70, machineType: 'SNLS', types: ['pants'] },
                    { name: 'Outseam Joining', cycleTime: 0.90, unit: 'minutes', rating: 100, allowance: 20, targetEff: 70, machineType: 'SNLS', types: ['pants'] },
                    { name: 'Leg Hemming', cycleTime: 0.70, unit: 'minutes', rating: 100, allowance: 15, targetEff: 70, machineType: 'SNLS', types: ['pants'] },
                    { name: 'Waistband Elastic', cycleTime: 0.50, unit: 'minutes', rating: 100, allowance: 20, targetEff: 70, machineType: 'SNLS', types: ['pants', 'skirt'] }
                ]
            },
            'Dresses': {
                icon: 'üëó',
                color: '#9b59b6',
                type: 'dress',
                operations: [
                    { name: 'Bodice Assembly', cycleTime: 1.00, unit: 'minutes', rating: 100, allowance: 25, targetEff: 70, machineType: 'SNLS', types: ['dress'] },
                    { name: 'Skirt Assembly', cycleTime: 0.80, unit: 'minutes', rating: 100, allowance: 25, targetEff: 70, machineType: 'SNLS', types: ['dress'] },
                    { name: 'Zipper Attachment', cycleTime: 0.60, unit: 'minutes', rating: 100, allowance: 20, targetEff: 70, machineType: 'SNLS', types: ['dress'] },
                    { name: 'Sleeve Setting', cycleTime: 0.50, unit: 'minutes', rating: 100, allowance: 20, targetEff: 70, machineType: 'SNLS', types: ['dress'] },
                    { name: 'Neckline Finish', cycleTime: 0.45, unit: 'minutes', rating: 100, allowance: 20, targetEff: 70, machineType: 'SNLS', types: ['dress'] },
                    { name: 'Lining Attachment', cycleTime: 1.20, unit: 'minutes', rating: 100, allowance: 25, targetEff: 70, machineType: 'SNLS', types: ['dress'] },
                    { name: 'Shoulder Straps', cycleTime: 0.35, unit: 'minutes', rating: 100, allowance: 15, targetEff: 70, machineType: 'SNLS', types: ['dress'] },
                    { name: 'Final Finishing', cycleTime: 0.40, unit: 'minutes', rating: 100, allowance: 15, targetEff: 70, machineType: 'SNLS', types: ['dress'] }
                ]
            },
            'Outerwear (Jackets, Coats)': {
                icon: 'üß•',
                color: '#e74c3c',
                type: 'jacket',
                operations: [
                    { name: 'Interlining/Fusing', cycleTime: 1.00, unit: 'minutes', rating: 100, allowance: 20, targetEff: 70, machineType: 'SNLS', types: ['jacket', 'coat'] },
                    { name: 'Lining Assembly', cycleTime: 2.00, unit: 'minutes', rating: 100, allowance: 30, targetEff: 70, machineType: 'SNLS', types: ['jacket', 'coat'] },
                    { name: 'Lapel Shaping', cycleTime: 1.20, unit: 'minutes', rating: 100, allowance: 25, targetEff: 70, machineType: 'SNLS', types: ['jacket', 'coat'] },
                    { name: 'Vent Construction', cycleTime: 1.80, unit: 'minutes', rating: 100, allowance: 30, targetEff: 70, machineType: 'SNLS', types: ['jacket', 'coat'] },
                    { name: 'Chest Canvas', cycleTime: 1.50, unit: 'minutes', rating: 100, allowance: 25, targetEff: 70, machineType: 'SNLS', types: ['jacket', 'coat'] },
                    { name: 'Button Stand', cycleTime: 1.00, unit: 'minutes', rating: 100, allowance: 25, targetEff: 70, machineType: 'SNLS', types: ['jacket', 'coat'] },
                    { name: 'Shoulder Pad', cycleTime: 0.50, unit: 'minutes', rating: 100, allowance: 15, targetEff: 70, machineType: 'SNLS', types: ['jacket', 'coat'] },
                    { name: 'Storm Flap', cycleTime: 1.20, unit: 'minutes', rating: 100, allowance: 25, targetEff: 70, machineType: 'SNLS', types: ['jacket', 'coat'] }
                ]
            },
            'Underwear & Bikinis': {
                icon: 'ü©≤',
                color: '#f39c12',
                type: 'underwear',
                operations: [
                    { name: 'Bra Cup Lamination', cycleTime: 0.50, unit: 'minutes', rating: 100, allowance: 20, targetEff: 70, machineType: 'SNLS', types: ['underwear', 'bikini'] },
                    { name: 'Bra Strap Attach', cycleTime: 0.30, unit: 'minutes', rating: 100, allowance: 15, targetEff: 70, machineType: 'SNLS', types: ['underwear', 'bikini'] },
                    { name: 'Elastic Picot Edge', cycleTime: 0.25, unit: 'minutes', rating: 100, allowance: 15, targetEff: 70, machineType: 'SNLS', types: ['underwear', 'bikini'] },
                    { name: 'Gusset Lining', cycleTime: 0.20, unit: 'minutes', rating: 100, allowance: 15, targetEff: 70, machineType: 'SNLS', types: ['underwear', 'bikini'] },
                    { name: 'Leg Elastic', cycleTime: 0.35, unit: 'minutes', rating: 100, allowance: 20, targetEff: 70, machineType: 'SNLS', types: ['underwear'] },
                    { name: 'Bra Hook & Eye', cycleTime: 0.25, unit: 'minutes', rating: 100, allowance: 15, targetEff: 70, machineType: 'SNLS', types: ['underwear', 'bikini'] },
                    { name: 'Bikini Tie', cycleTime: 0.20, unit: 'minutes', rating: 100, allowance: 15, targetEff: 70, machineType: 'SNLS', types: ['bikini'] },
                    { name: 'Adjustable Strap', cycleTime: 0.25, unit: 'minutes', rating: 100, allowance: 15, targetEff: 70, machineType: 'SNLS', types: ['underwear', 'bikini'] }
                ]
            },
            'Finishing (Universal)': {
                icon: '‚úÖ',
                color: '#95a5a6',
                type: 'finishing',
                operations: [
                    { name: 'Buttonhole Stitching', cycleTime: 0.30, unit: 'minutes', rating: 100, allowance: 10, targetEff: 70, machineType: 'SNLS', types: ['all'] },
                    { name: 'Button Attachment', cycleTime: 0.20, unit: 'minutes', rating: 100, allowance: 10, targetEff: 70, machineType: 'SNLS', types: ['all'] },
                    { name: 'Thread Trimming', cycleTime: 0.15, unit: 'minutes', rating: 100, allowance: 5, targetEff: 70, machineType: 'SNLS', types: ['all'] },
                    { name: 'Ironing/Pressing', cycleTime: 0.50, unit: 'minutes', rating: 100, allowance: 15, targetEff: 70, machineType: 'SNLS', types: ['all'] },
                    { name: 'Quality Control', cycleTime: 0.70, unit: 'minutes', rating: 100, allowance: 20, targetEff: 70, machineType: 'SNLS', types: ['all'] },
                    { name: 'Packaging', cycleTime: 0.40, unit: 'minutes', rating: 100, allowance: 15, targetEff: 70, machineType: 'SNLS', types: ['all'] },
                    { name: 'Hang Tag', cycleTime: 0.10, unit: 'minutes', rating: 100, allowance: 5, targetEff: 70, machineType: 'SNLS', types: ['all'] },
                    { name: 'Size Label', cycleTime: 0.15, unit: 'minutes', rating: 100, allowance: 10, targetEff: 70, machineType: 'SNLS', types: ['all'] }
                ]
            }
        };

        let operationCount = 0;
        let currentGarmentType = 'T-Shirt';
        let savedGarments = JSON.parse(localStorage.getItem('savedGarments')) || {};
        let selectedOperations = new Map();
        let hasInitialized = false;
        let currentLayout = 'vertical';
        let currentOperation = 1;

        // Layout Toggle Function
        function toggleLayout() {
            const layoutBtn = document.getElementById('layoutToggleBtn');
            const operationsContainer = document.getElementById('operations-container');
            
            if (currentLayout === 'vertical') {
                currentLayout = 'horizontal';
                layoutBtn.innerHTML = '<i class="fas fa-columns"></i> Switch to Vertical';
                layoutBtn.className = 'layout-toggle-btn horizontal';
                operationsContainer.classList.remove('vertical');
                operationsContainer.classList.add('horizontal');
                document.getElementById('operation-nav-controls').style.display = 'none';
            } else {
                currentLayout = 'vertical';
                layoutBtn.innerHTML = '<i class="fas fa-list"></i> Switch to Horizontal';
                layoutBtn.className = 'layout-toggle-btn vertical';
                operationsContainer.classList.remove('horizontal');
                operationsContainer.classList.add('vertical');
                updateNavigationControls();
            }
            
            updateOperationCardsForLayout();
        }

        function updateOperationCardsForLayout() {
            const operations = document.querySelectorAll('.operation-card');
            operations.forEach(card => {
                if (currentLayout === 'horizontal') {
                    card.style.minWidth = '304px';
                    card.style.maxWidth = '304px';
                    card.style.height = '448px';
                    card.style.flexShrink = '0';
                    card.style.display = 'flex';
                } else {
                    card.style.minWidth = '0';
                    card.style.maxWidth = '100%';
                    card.style.height = 'auto';
                    card.style.flexShrink = 'unset';
                    const opId = parseInt(card.id.replace('operation-', ''));
                    card.style.display = opId === currentOperation ? 'flex' : 'none';
                }
            });
        }

        // Switch between operations
        function switchOperation(direction) {
            const operations = document.querySelectorAll('.operation-card');
            if (operations.length <= 1) return;
            
            let newOperation = currentOperation + direction;
            
            if (newOperation < 1) {
                newOperation = operations.length;
            } else if (newOperation > operations.length) {
                newOperation = 1;
            }
            
            // Update current operation
            currentOperation = newOperation;
            
            // Update operation display
            operations.forEach((card, index) => {
                const opId = index + 1;
                card.style.display = opId === currentOperation ? 'flex' : 'none';
            });
            
            // Update active tab
            document.querySelectorAll('.operation-tab').forEach((tab, index) => {
                if (index + 1 === currentOperation) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            // Update navigation controls
            updateNavigationControls();
        }

        // Update navigation controls
        function updateNavigationControls() {
            const operations = document.querySelectorAll('.operation-card');
            const navControls = document.getElementById('operation-nav-controls');
            const currentOpNumber = document.getElementById('current-op-number');
            const totalOpsCount = document.getElementById('total-ops-count');
            const prevBtn = document.getElementById('prev-op-btn');
            const nextBtn = document.getElementById('next-op-btn');
            
            if (operations.length <= 1 || currentLayout === 'horizontal') {
                navControls.style.display = 'none';
                return;
            }
            
            navControls.style.display = 'flex';
            currentOpNumber.textContent = currentOperation;
            totalOpsCount.textContent = operations.length;
            
            // Update button states
            prevBtn.disabled = operations.length <= 1;
            nextBtn.disabled = operations.length <= 1;
        }

        // Modal Functions
        function showModal(title, message, showCancel = false, confirmCallback = null, cancelCallback = null) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('modalCancelBtn').style.display = showCancel ? 'block' : 'none';
            
            const modal = document.getElementById('customModal');
            modal.style.display = 'flex';
            
            document.getElementById('modalConfirmBtn').onclick = function() {
                hideModal();
                if (confirmCallback) confirmCallback();
            };
            
            document.getElementById('modalCancelBtn').onclick = function() {
                hideModal();
                if (cancelCallback) cancelCallback();
            };
            
            modal.onclick = function(e) {
                if (e.target === modal) {
                    hideModal();
                    if (cancelCallback) cancelCallback();
                }
            };
        }
        
        function hideModal() {
            document.getElementById('customModal').style.display = 'none';
        }

        // Tab Switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.currentTarget.classList.add('active');
            
            if (tabName === 'dashboard') {
                updateDashboard();
            }
        }

        // Garment Functions
        function setGarmentTypeFromDropdown() {
            const select = document.getElementById('garment-type-select');
            const selectedValue = select.value;
            
            if (selectedValue && selectedValue !== "") {
                currentGarmentType = selectedValue;
                updateDropdownWithSavedGarments();
            }
        }

        function setGarmentType(type) {
            currentGarmentType = type;
            const select = document.getElementById('garment-type-select');
            select.value = type;
            updateDropdownWithSavedGarments();
        }

        function updateGarmentType() {
            const select = document.getElementById('garment-type-select');
            const selectedValue = select.value;
            
            if (selectedValue && selectedValue !== "") {
                currentGarmentType = selectedValue;
            }
        }

        function updateDropdownWithSavedGarments() {
            const select = document.getElementById('garment-type-select');
            const currentValue = select.value;
            
            const placeholderOption = select.querySelector('option[disabled]');
            
            select.innerHTML = '';
            
            if (placeholderOption) {
                select.appendChild(placeholderOption);
            }
            
            const standardOptions = [
                'T-Shirt',
                'Dress Shirt', 
                'Pants',
                'Jacket',
                'Dress',
                'Bikini',
                'Underwear',
                'Custom Garment'
            ];
            
            standardOptions.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option;
                opt.textContent = option;
                select.appendChild(opt);
            });
            
            const savedGarmentNames = Object.keys(savedGarments);
            if (savedGarmentNames.length > 0) {
                const separator = document.createElement('option');
                separator.disabled = true;
                separator.textContent = '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Saved Garments ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ';
                select.appendChild(separator);
                
                savedGarmentNames.forEach(name => {
                    if (!standardOptions.includes(name)) {
                        const opt = document.createElement('option');
                        opt.value = name;
                        opt.textContent = name + ' (Saved)';
                        select.appendChild(opt);
                    }
                });
            }
            
            if (currentValue) {
                select.value = currentValue;
            }
        }

        function saveGarmentType() {
            const garmentType = document.getElementById('garment-type-select').value;
            
            if (!garmentType || garmentType === "") {
                showModal("Input Required", "Please select a garment type to save.");
                return;
            }
            
            if (!savedGarments[garmentType]) {
                savedGarments[garmentType] = [];
                
                document.querySelectorAll('.operation-card').forEach((card, index) => {
                    const opId = index + 1;
                    savedGarments[garmentType].push({
                        name: document.getElementById(`op${opId}-name`).value,
                        cycleTime: parseFloat(document.getElementById(`op${opId}-cycle`).value) || 0.5,
                        unit: document.getElementById(`op${opId}-unit`).value,
                        rating: parseFloat(document.getElementById(`op${opId}-rating`).value) || 100,
                        allowance: parseFloat(document.getElementById(`op${opId}-allowance`).value) || 20,
                        targetEff: parseFloat(document.getElementById(`op${opId}-target-eff`).value) || 70,
                        machineType: document.getElementById(`op${opId}-machine-type`).value || 'SNLS'
                    });
                });
                
                localStorage.setItem('savedGarments', JSON.stringify(savedGarments));
                updateDropdownWithSavedGarments();
                setGarmentType(garmentType);
                showModal("Saved", `"${garmentType}" has been saved with ${savedGarments[garmentType].length} operations.`);
            } else {
                showModal("Already Exists", `"${garmentType}" is already saved.`);
            }
        }

        function loadSavedGarment(garmentType) {
            setGarmentType(garmentType);
            
            document.getElementById('operations-container').innerHTML = '';
            document.getElementById('operation-tabs').innerHTML = '';
            operationCount = 0;
            
            if (savedGarments[garmentType]) {
                savedGarments[garmentType].forEach(op => {
                    addOperation(op.name, op.cycleTime, op.unit, op.rating, op.allowance, op.targetEff, op.machineType);
                });
                calculateAllOperations();
                showModal("Loaded", `Loaded ${savedGarments[garmentType].length} operations for "${garmentType}".`);
            }
        }

        function loadPresetOperations() {
            const garmentType = document.getElementById('garment-type-select').value;
            
            if (!garmentType || garmentType === "") {
                showModal("Input Required", "Please select a garment type first.");
                return;
            }
            
            document.getElementById('operations-container').innerHTML = '';
            document.getElementById('operation-tabs').innerHTML = '';
            operationCount = 0;
            
            let presetKey = Object.keys(garmentPresets).find(key => 
                key.toLowerCase() === garmentType.toLowerCase()
            );
            
            if (!presetKey) {
                for (const key in garmentPresets) {
                    if (garmentType.toLowerCase().includes(key.toLowerCase()) || 
                        key.toLowerCase().includes(garmentType.toLowerCase())) {
                        presetKey = key;
                        break;
                    }
                }
            }
            
            const operations = presetKey ? garmentPresets[presetKey] : garmentPresets['Custom Garment'] || [];
            
            operations.forEach(op => {
                addOperation(op.name, op.cycleTime, op.unit, op.rating, op.allowance, op.targetEff, op.machineType);
            });
            
            calculateAllOperations();
            showModal("Preset Loaded", `Loaded ${operations.length} operations for ${garmentType}.`);
        }

        // Operation Management
        function addOperation(name, cycleTime, unit, rating, allowance, targetEff = 70, machineType = 'SNLS') {
            operationCount++;
            const opId = operationCount;
            
            // Create operation tab
            const operationTabs = document.getElementById('operation-tabs');
            const operationTab = document.createElement('button');
            operationTab.className = `operation-tab ${opId === 1 ? 'active' : ''}`;
            operationTab.id = `operation-tab-${opId}`;
            operationTab.innerHTML = `
                OP#${opId}
                <button class="operation-tab-close" onclick="removeOperationTab(${opId}, event)">&times;</button>
            `;
            operationTab.onclick = () => switchToOperation(opId);
            operationTabs.appendChild(operationTab);
            
            // Create operation card
            const operation = document.createElement('div');
            operation.className = 'operation-card';
            operation.id = `operation-${opId}`;
            operation.style.display = currentLayout === 'vertical' && opId !== 1 ? 'none' : 'flex';
            operation.innerHTML = `
                <div class="operation-header">
                    <div class="operation-number-btn">OP#${opId}</div>
                    <div class="operation-header-buttons">
                        <button type="button" class="btn-add-operation" onclick="addNewOperation()">
                            <i class="fas fa-plus"></i> + Add
                        </button>
                        <button type="button" class="btn-remove-operation" onclick="removeOperation(${opId})">
                            <i class="fas fa-minus"></i> - Remove
                        </button>
                    </div>
                </div>
                
                <div class="operation-inputs">
                    <!-- Operation Name - Full width -->
                    <div class="input-group full-width">
                        <div class="label-with-tooltip">
                            <div class="tooltip-icon" tabindex="0">
                                i
                                <div class="tooltip-text">
                                    <strong>Operation Name</strong><br>
                                    The name or description of this sewing operation. Be specific to identify the task clearly (e.g., "Sleeve Attachment" or "Collar Making").
                                </div>
                            </div>
                            <label class="required" for="op${opId}-name">Operation Name</label>
                        </div>
                        <input type="text" id="op${opId}-name" value="${name}" oninput="calculateSAM(${opId}); calculateAllOperations();">
                    </div>
                    
                    <!-- MACHINE TYPE -->
                    <div class="input-group">
                        <div class="label-with-tooltip">
                            <div class="tooltip-icon" tabindex="0">
                                i
                                <div class="tooltip-text">
                                    <strong>Machine Type</strong><br>
                                    Type of sewing machine used for this operation.<br>
                                    ‚Ä¢ SNLS: Single Needle Lock Stitch (basic stitching)<br>
                                    ‚Ä¢ Overlock: For edge finishing<br>
                                    ‚Ä¢ Flatlock: For stretch fabrics and seams<br>
                                    ‚Ä¢ Feed-off-arm: For specialized operations<br>
                                    ‚Ä¢ Manual: Hand operations
                                </div>
                            </div>
                            <label class="required" for="op${opId}-machine-type">MACHINE TYPE</label>
                        </div>
                        <select id="op${opId}-machine-type" oninput="calculateAllOperations()">
                            <option value="SNLS" ${machineType === 'SNLS' ? 'selected' : ''}>SNLS</option>
                            <option value="Overlock" ${machineType === 'Overlock' ? 'selected' : ''}>Overlock</option>
                            <option value="Flatlock" ${machineType === 'Flatlock' ? 'selected' : ''}>Flatlock</option>
                            <option value="Feed-off-arm" ${machineType === 'Feed-off-arm' ? 'selected' : ''}>Feed-off-arm</option>
                            <option value="Manual" ${machineType === 'Manual' ? 'selected' : ''}>Manual</option>
                        </select>
                    </div>
                    
                    <!-- Cycle Time -->
                    <div class="input-group">
                        <div class="label-with-tooltip">
                            <div class="tooltip-icon" tabindex="0">
                                i
                                <div class="tooltip-text">
                                    <strong>Cycle Time</strong><br>
                                    The actual time taken to complete one cycle of this operation.<br>
                                    Measured by time study. Typical range: 0.1 to 2.0 minutes.<br>
                                    This is the raw time before applying rating or allowances.
                                </div>
                            </div>
                            <label class="required" for="op${opId}-cycle">Cycle Time</label>
                        </div>
                        <input type="number" id="op${opId}-cycle" min="0" step="0.01" value="${cycleTime}" oninput="calculateSAM(${opId}); calculateAllOperations();">
                    </div>
                    
                    <!-- Time Unit -->
                    <div class="input-group">
                        <div class="label-with-tooltip">
                            <div class="tooltip-icon" tabindex="0">
                                i
                                <div class="tooltip-text">
                                    <strong>Time Unit</strong><br>
                                    Unit of measurement for the cycle time.<br>
                                    ‚Ä¢ Minutes: Most common unit for garment operations<br>
                                    ‚Ä¢ Seconds: For very fast operations<br>
                                    Note: 1 minute = 60 seconds
                                </div>
                            </div>
                            <label class="required" for="op${opId}-unit">Time Unit</label>
                        </div>
                        <select id="op${opId}-unit" onchange="calculateSAM(${opId}); calculateAllOperations();">
                            <option value="minutes" ${unit === 'minutes' ? 'selected' : ''}>Minutes</option>
                            <option value="seconds" ${unit === 'seconds' ? 'selected' : ''}>Seconds</option>
                        </select>
                    </div>
                    
                    <!-- Performance Rating -->
                    <div class="input-group">
                        <div class="label-with-tooltip">
                            <div class="tooltip-icon" tabindex="0">
                                i
                                <div class="tooltip-text">
                                    <strong>Performance Rating (%)</strong><br>
                                    Assessment of operator speed compared to standard pace.<br>
                                    ‚Ä¢ 100% = Standard performance (normal pace)<br>
                                    ‚Ä¢ Below 100% = Slower than standard<br>
                                    ‚Ä¢ Above 100% = Faster than standard<br>
                                    Industry standard: 70-130%
                                </div>
                            </div>
                            <label class="required" for="op${opId}-rating">Performance Rating (%)</label>
                        </div>
                        <input type="number" id="op${opId}-rating" min="0" max="200" step="1" value="${rating}" oninput="calculateSAM(${opId}); calculateAllOperations();">
                    </div>
                    
                    <!-- Allowance -->
                    <div class="input-group">
                        <div class="label-with-tooltip">
                            <div class="tooltip-icon" tabindex="0">
                                i
                                <div class="tooltip-text">
                                    <strong>Allowance (%)</strong><br>
                                    Additional time added to basic time for various factors:<br>
                                    ‚Ä¢ Personal needs (5%)<br>
                                    ‚Ä¢ Fatigue (5-10%)<br>
                                    ‚Ä¢ Machine delays (5%)<br>
                                    ‚Ä¢ Bundle handling (5-10%)<br>
                                    Total allowances typically: 15-30%
                                </div>
                            </div>
                            <label class="required" for="op${opId}-allowance">Allowance (%)</label>
                        </div>
                        <input type="number" id="op${opId}-allowance" min="0" max="100" step="1" value="${allowance}" oninput="calculateSAM(${opId}); calculateAllOperations();">
                    </div>
                    
                    <!-- TARGET EFF (%) -->
                    <div class="input-group">
                        <div class="label-with-tooltip">
                            <div class="tooltip-icon" tabindex="0">
                                i
                                <div class="tooltip-text">
                                    <strong>TARGET EFF (%)</strong><br>
                                    Target efficiency percentage for this operation.<br>
                                    Used to calculate production targets and capacity planning.<br>
                                    ‚Ä¢ 70% = Conservative target<br>
                                    ‚Ä¢ 80% = Standard target<br>
                                    ‚Ä¢ 90% = Ambitious target<br>
                                    ‚Ä¢ 100% = Maximum theoretical
                                </div>
                            </div>
                            <label class="required" for="op${opId}-target-eff">TARGET EFF (%)</label>
                        </div>
                        <input type="number" id="op${opId}-target-eff" min="0" max="200" step="1" value="${targetEff}" oninput="calculateAllOperations()">
                    </div>
                </div>
                
                <div class="result-box">
                    <div class="result-item">
                        <div class="result-value" id="op${opId}-sam">0.000</div>
                        <div class="result-label">Operation SAM</div>
                    </div>
                    <div class="result-item">
                        <div class="result-value" id="op${opId}-pieces">0</div>
                        <div class="result-label">Cap/Hr (100%)</div>
                    </div>
                </div>
            `;
            
            document.getElementById('operations-container').appendChild(operation);
            calculateSAM(opId);
            document.getElementById('summary-section').style.display = 'none';
            
            initTooltipsForOperation(opId);
            updateOperationCardsForLayout();
            updateNavigationControls();
        }

        // Switch to specific operation
        function switchToOperation(opId) {
            currentOperation = opId;
            
            const operations = document.querySelectorAll('.operation-card');
            operations.forEach((card, index) => {
                const cardOpId = index + 1;
                card.style.display = cardOpId === opId ? 'flex' : 'none';
            });
            
            document.querySelectorAll('.operation-tab').forEach((tab, index) => {
                if (index + 1 === opId) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            updateNavigationControls();
        }

        // Remove operation tab
        function removeOperationTab(opId, event) {
            event.stopPropagation();
            removeOperation(opId);
        }

        // Initialize tooltips for a specific operation
        function initTooltipsForOperation(opId) {
            const tooltipIcons = document.querySelectorAll(`#operation-${opId} .tooltip-icon`);
            
            tooltipIcons.forEach(icon => {
                icon.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    document.querySelectorAll('.tooltip-icon').forEach(otherIcon => {
                        if (otherIcon !== this) {
                            otherIcon.classList.remove('active');
                        }
                    });
                    
                    this.classList.toggle('active');
                    
                    const closeTooltip = (event) => {
                        if (!this.contains(event.target)) {
                            this.classList.remove('active');
                            document.removeEventListener('touchstart', closeTooltip);
                        }
                    };
                    
                    setTimeout(() => {
                        document.addEventListener('touchstart', closeTooltip);
                    }, 10);
                });
                
                icon.addEventListener('mouseenter', function() {
                    if (window.innerWidth > 768) {
                        this.classList.add('active');
                    }
                });
                
                icon.addEventListener('mouseleave', function() {
                    if (window.innerWidth > 768) {
                        this.classList.remove('active');
                    }
                });
                
                icon.addEventListener('focus', function() {
                    this.classList.add('active');
                });
                
                icon.addEventListener('blur', function() {
                    this.classList.remove('active');
                });
            });
        }

        function addNewOperation() {
            addOperation('New Operation', 0.50, 'minutes', 100, 20);
        }

        function calculateSAM(opId) {
            const cycleTime = parseFloat(document.getElementById(`op${opId}-cycle`).value) || 0;
            const timeUnit = document.getElementById(`op${opId}-unit`).value;
            const rating = parseFloat(document.getElementById(`op${opId}-rating`).value) || 100;
            const allowance = parseFloat(document.getElementById(`op${opId}-allowance`).value) || 0;
            
            let cycleTimeMinutes = cycleTime;
            if (timeUnit === 'seconds') {
                cycleTimeMinutes = cycleTime / 60;
            }
            
            const basicTime = cycleTimeMinutes * (rating / 100);
            const sam = basicTime * (1 + (allowance / 100));
            const piecesPerHour = sam > 0 ? Math.round(60 / sam) : 0;
            
            document.getElementById(`op${opId}-sam`).textContent = sam.toFixed(3);
            document.getElementById(`op${opId}-pieces`).textContent = piecesPerHour;
            
            return { sam, piecesPerHour };
        }

        function calculateAllOperationsSilently() {
            const operations = document.querySelectorAll('.operation-card');
            if (operations.length === 0) return;
            
            let totalSAM = 0;
            operations.forEach((op, index) => {
                const result = calculateSAM(index + 1);
                totalSAM += result.sam;
            });
            
            const shiftTime = parseFloat(document.getElementById('shift-time').value) || 480;
            const totalOperators = parseFloat(document.getElementById('total-operators').value) || 1;
            const targetEff = (parseFloat(document.getElementById('op1-target-eff')?.value) || 70) / 100;
            
            const totalAvailableMinutes = shiftTime * totalOperators;
            const dailyTarget = totalSAM > 0 ? Math.floor((totalAvailableMinutes / totalSAM) * targetEff) : 0;
            const targetPcsHr = dailyTarget > 0 ? Math.round(dailyTarget / (shiftTime / 60)) : 0;
            const pitchTime = totalSAM > 0 ? (totalSAM / totalOperators) : 0;
            
            document.getElementById('total-sam').textContent = totalSAM.toFixed(2);
            document.getElementById('target-pcs-hr').textContent = targetPcsHr;
            document.getElementById('daily-target').textContent = dailyTarget;
            document.getElementById('pitch-time').textContent = pitchTime.toFixed(2);
            
            document.getElementById('summary-section').style.display = 'grid';
            updateDashboard();
        }

        function calculateAllOperations() {
            const operations = document.querySelectorAll('.operation-card');
            if (operations.length === 0) {
                showModal("No Operations", "Please add at least one operation.");
                return;
            }
            
            let totalSAM = 0;
            operations.forEach((op, index) => {
                const result = calculateSAM(index + 1);
                totalSAM += result.sam;
            });
            
            const shiftTime = parseFloat(document.getElementById('shift-time').value) || 480;
            const totalOperators = parseFloat(document.getElementById('total-operators').value) || 1;
            const targetEff = (parseFloat(document.getElementById('op1-target-eff')?.value) || 70) / 100;
            
            const totalAvailableMinutes = shiftTime * totalOperators;
            const dailyTarget = totalSAM > 0 ? Math.floor((totalAvailableMinutes / totalSAM) * targetEff) : 0;
            const targetPcsHr = dailyTarget > 0 ? Math.round(dailyTarget / (shiftTime / 60)) : 0;
            const pitchTime = totalSAM > 0 ? (totalSAM / totalOperators) : 0;
            
            document.getElementById('total-sam').textContent = totalSAM.toFixed(2);
            document.getElementById('target-pcs-hr').textContent = targetPcsHr;
            document.getElementById('daily-target').textContent = dailyTarget;
            document.getElementById('pitch-time').textContent = pitchTime.toFixed(2);
            
            document.getElementById('summary-section').style.display = 'grid';
            updateDashboard();
            
            if (hasInitialized) {
                showModal("Calculated", `Total SAM: ${totalSAM.toFixed(2)} minutes\nDaily Target: ${dailyTarget} pieces\nTarget Efficiency: ${targetEff * 100}%`);
            }
        }

        function removeOperation(opId) {
            const operations = document.querySelectorAll('.operation-card');
            if (operations.length <= 1) {
                showModal("Cannot Remove", "You need at least one operation.");
                return;
            }
            
            showModal("Confirm", "Remove this operation?", true,
                () => {
                    // Remove operation card
                    document.getElementById(`operation-${opId}`).remove();
                    
                    // Remove operation tab
                    const tab = document.getElementById(`operation-tab-${opId}`);
                    if (tab) tab.remove();
                    
                    // Update current operation if needed
                    if (currentOperation >= opId && currentOperation > 1) {
                        currentOperation--;
                    }
                    
                    renumberOperations();
                    document.getElementById('summary-section').style.display = 'none';
                    calculateAllOperations();
                    updateNavigationControls();
                }
            );
        }

        function renumberOperations() {
            const operations = document.querySelectorAll('.operation-card');
            operationCount = operations.length;
            
            operations.forEach((op, index) => {
                const newId = index + 1;
                op.id = `operation-${newId}`;
                
                const operationBtn = op.querySelector('.operation-number-btn');
                if (operationBtn) {
                    operationBtn.textContent = `OP#${newId}`;
                }
                
                op.querySelector('.btn-remove-operation').setAttribute('onclick', `removeOperation(${newId})`);
                
                ['name', 'cycle', 'unit', 'rating', 'allowance', 'target-eff', 'machine-type', 'sam', 'pieces'].forEach(field => {
                    const elem = op.querySelector(`[id*="${field}"]`);
                    if (elem) {
                        elem.id = elem.id.replace(/op\d+/, `op${newId}`);
                        if (field === 'sam' || field === 'pieces') {
                            elem.id = `op${newId}-${field}`;
                        }
                    }
                });
            });
            
            // Renumber tabs
            const operationTabs = document.getElementById('operation-tabs');
            const tabs = operationTabs.querySelectorAll('.operation-tab');
            
            operationTabs.innerHTML = '';
            
            tabs.forEach((tab, index) => {
                const newId = index + 1;
                tab.id = `operation-tab-${newId}`;
                tab.innerHTML = `OP#${newId}<button class="operation-tab-close" onclick="removeOperationTab(${newId}, event)">&times;</button>`;
                tab.onclick = () => switchToOperation(newId);
                if (newId === currentOperation) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
                operationTabs.appendChild(tab);
            });
        }

        function clearAllOperations() {
            const operations = document.querySelectorAll('.operation-card');
            if (operations.length === 0) {
                showModal("No Operations", "There are no operations to clear.");
                return;
            }
            
            showModal("Confirm", "Clear all operations?", true,
                () => {
                    document.getElementById('operations-container').innerHTML = '';
                    document.getElementById('operation-tabs').innerHTML = '';
                    operationCount = 0;
                    currentOperation = 1;
                    addNewOperation();
                    document.getElementById('summary-section').style.display = 'none';
                    document.getElementById('operation-nav-controls').style.display = 'none';
                    showModal("Cleared", "All operations have been cleared.");
                }
            );
        }

        function updateDashboard() {
            const totalSAM = document.getElementById('total-sam').textContent || '0.00';
            const targetPcsHr = document.getElementById('target-pcs-hr').textContent || '0';
            const dailyTarget = document.getElementById('daily-target').textContent || '0';
            
            document.getElementById('dashboard-total-sam').textContent = totalSAM;
            document.getElementById('dashboard-pieces-hour').textContent = targetPcsHr;
            document.getElementById('dashboard-daily-target').textContent = dailyTarget;
        }

        function exportToExcel() {
            const operations = document.querySelectorAll('.operation-card');
            if (operations.length === 0) {
                showModal("No Data", "No operations to export.");
                return;
            }
            
            let data = "Operation Name,Cycle Time,Unit,Rating (%),Allowance (%),TARGET EFF (%),MACHINE TYPE,SAM (min),Pieces/Hour\n";
            
            operations.forEach((op, index) => {
                const opId = index + 1;
                data += `"${document.getElementById(`op${opId}-name`).value}",`;
                data += `${document.getElementById(`op${opId}-cycle`).value},`;
                data += `${document.getElementById(`op${opId}-unit`).value},`;
                data += `${document.getElementById(`op${opId}-rating`).value},`;
                data += `${document.getElementById(`op${opId}-allowance`).value},`;
                data += `${document.getElementById(`op${opId}-target-eff`).value},`;
                data += `${document.getElementById(`op${opId}-machine-type`).value},`;
                data += `${document.getElementById(`op${opId}-sam`).textContent},`;
                data += `${document.getElementById(`op${opId}-pieces`).textContent}\n`;
            });
            
            const garmentType = document.getElementById('garment-type-select').value || 'Custom';
            const blob = new Blob([data], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `garment-calculator-${garmentType.replace(/\s+/g, '-')}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showModal("Exported", "Data exported to CSV file.");
        }

        // PDF Report Generation
        async function generatePDFReport() {
            const operations = document.querySelectorAll('.operation-card');
            if (operations.length === 0) {
                showModal("No Data", "No operations to generate report.");
                return;
            }
            
            try {
                showModal("Generating Report", "Please wait while we generate your PDF report...", false);
                
                const pdfContainer = document.createElement('div');
                pdfContainer.style.position = 'absolute';
                pdfContainer.style.left = '-9999px';
                pdfContainer.style.top = '-9999px';
                pdfContainer.style.width = '800px';
                pdfContainer.style.padding = '20px';
                pdfContainer.style.backgroundColor = 'white';
                pdfContainer.style.color = 'black';
                pdfContainer.style.fontFamily = 'Arial, sans-serif';
                
                const garmentType = document.getElementById('garment-type-select').value || 'Custom Garment';
                const shiftTime = document.getElementById('shift-time').value || '480';
                const totalOperators = document.getElementById('total-operators').value || '10';
                const targetEff = document.getElementById('op1-target-eff')?.value || '70';
                const machineType = document.getElementById('op1-machine-type')?.value || 'SNLS';
                
                pdfContainer.innerHTML = `
                    <h1 style="color: #2c3e50; text-align: center; margin-bottom: 20px;">Garment SAM Report</h1>
                    <div style="border-bottom: 2px solid #3498db; margin-bottom: 20px; padding-bottom: 10px;">
                        <h2 style="color: #3498db; margin-bottom: 10px;">Production Summary</h2>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div><strong>Garment Type:</strong> ${garmentType}</div>
                            <div><strong>Shift Time:</strong> ${shiftTime} minutes</div>
                            <div><strong>Total Operators:</strong> ${totalOperators}</div>
                            <div><strong>Target Efficiency:</strong> ${targetEff}%</div>
                            <div><strong>Machine Type:</strong> ${machineType}</div>
                            <div><strong>Report Date:</strong> ${new Date().toLocaleDateString()}</div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h2 style="color: #3498db; margin-bottom: 10px;">Production Metrics</h2>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; background: #f8f9fa; padding: 15px; border-radius: 8px;">
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #f39c12;">${document.getElementById('total-sam').textContent}</div>
                                <div style="font-size: 12px; color: #666;">Total SAM (min)</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #2ecc71;">${document.getElementById('target-pcs-hr').textContent}</div>
                                <div style="font-size: 12px; color: #666;">Target Pcs/Hr</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #3498db;">${document.getElementById('daily-target').textContent}</div>
                                <div style="font-size: 12px; color: #666;">Daily Target</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #9b59b6;">${document.getElementById('pitch-time').textContent}</div>
                                <div style="font-size: 12px; color: #666;">Pitch Time (min)</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h2 style="color: #3498db; margin-bottom: 10px;">Operations List</h2>
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #3498db; color: white;">
                                    <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">#</th>
                                    <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Operation Name</th>
                                    <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Cycle Time</th>
                                    <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Rating %</th>
                                    <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Allow %</th>
                                    <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">TARGET EFF %</th>
                                    <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">MACHINE TYPE</th>
                                    <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">SAM (min)</th>
                                    <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Cap/Hr</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Array.from(operations).map((op, index) => {
                                    const opId = index + 1;
                                    return `
                                        <tr style="${index % 2 === 0 ? 'background: #f8f9fa;' : ''}">
                                            <td style="padding: 10px; border: 1px solid #ddd;">OP#${opId}</td>
                                            <td style="padding: 10px; border: 1px solid #ddd;">${document.getElementById(`op${opId}-name`).value}</td>
                                            <td style="padding: 10px; border: 1px solid #ddd;">${document.getElementById(`op${opId}-cycle`).value} ${document.getElementById(`op${opId}-unit`).value}</td>
                                            <td style="padding: 10px; border: 1px solid #ddd;">${document.getElementById(`op${opId}-rating`).value}%</td>
                                            <td style="padding: 10px; border: 1px solid #ddd;">${document.getElementById(`op${opId}-allowance`).value}%</td>
                                            <td style="padding: 10px; border: 1px solid #ddd;">${document.getElementById(`op${opId}-target-eff`).value}%</td>
                                            <td style="padding: 10px; border: 1px solid #ddd;">${document.getElementById(`op${opId}-machine-type`).value}</td>
                                            <td style="padding: 10px; border: 1px solid #ddd;">${document.getElementById(`op${opId}-sam`).textContent}</td>
                                            <td style="padding: 10px; border: 1px solid #ddd;">${document.getElementById(`op${opId}-pieces`).textContent}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <div style="border-top: 2px solid #3498db; padding-top: 15px; margin-top: 20px;">
                        <h2 style="color: #3498db; margin-bottom: 10px;">Production Analysis</h2>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <h3 style="color: #2c3e50; font-size: 16px; margin-bottom: 10px;">Key Findings</h3>
                                <ul style="padding-left: 20px; color: #555;">
                                    <li>Total operations: ${operations.length}</li>
                                    <li>Average SAM per operation: ${(parseFloat(document.getElementById('total-sam').textContent) / operations.length).toFixed(3)} minutes</li>
                                    <li>Highest capacity operation: ${Array.from(operations).reduce((max, op, idx) => {
                                        const pieces = parseInt(document.getElementById(`op${idx+1}-pieces`).textContent);
                                        return pieces > max.pieces ? {index: idx, pieces} : max;
                                    }, {index: 0, pieces: 0}).pieces} pcs/hr</li>
                                </ul>
                            </div>
                            <div>
                                <h3 style="color: #2c3e50; font-size: 16px; margin-bottom: 10px;">Recommendations</h3>
                                <ul style="padding-left: 20px; color: #555;">
                                    <li>Review operations with SAM > 1 minute for optimization</li>
                                    <li>Consider balancing workload across operations</li>
                                    <li>Evaluate allowance percentages for accuracy</li>
                                    <li>Monitor daily target achievement regularly</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px; padding-top: 15px; border-top: 1px solid #ddd; text-align: center; color: #666; font-size: 12px;">
                        <p>Generated by Garment SAM Calculator ‚Ä¢ ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}</p>
                    </div>
                `;
                
                document.body.appendChild(pdfContainer);
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                
                await html2canvas(pdfContainer, {
                    scale: 2,
                    useCORS: true,
                    logging: false
                }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const imgWidth = 210;
                    const pageHeight = 297;
                    const imgHeight = canvas.height * imgWidth / canvas.width;
                    
                    doc.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                    
                    doc.save(`Garment-SAM-Report-${garmentType.replace(/\s+/g, '-')}-${new Date().toISOString().slice(0,10)}.pdf`);
                    
                    document.body.removeChild(pdfContainer);
                    hideModal();
                    showModal("Report Generated", "PDF report has been generated and downloaded successfully.");
                });
                
            } catch (error) {
                console.error('PDF generation error:', error);
                hideModal();
                showModal("Error", "Failed to generate PDF report. Please try again.");
            }
        }

        // Operations Library Functions
        function showOperationsLibrary() {
            const library = document.getElementById('operations-library');
            library.innerHTML = '';
            selectedOperations.clear();
            updateSelectedCount();
            
            let categoryIndex = 0;
            for (const [categoryName, categoryData] of Object.entries(operationsLibrary)) {
                const section = document.createElement('div');
                section.className = 'category-section';
                section.id = `category-${categoryIndex}`;
                
                section.innerHTML = `
                    <div class="category-header">
                        <div class="category-title">
                            <div class="category-icon" style="background: ${categoryData.color}">${categoryData.icon}</div>
                            <div>
                                <div>${categoryName}</div>
                                <div style="font-size: 13px; color: #7f8c8d;">${categoryData.operations.length} operations</div>
                            </div>
                        </div>
                        <label class="select-all-category">
                            <input type="checkbox" id="select-all-${categoryIndex}" onchange="toggleCategorySelection(${categoryIndex})">
                            Select All
                        </label>
                    </div>
                    <div class="operations-grid" id="operations-grid-${categoryIndex}"></div>
                `;
                
                const grid = section.querySelector(`#operations-grid-${categoryIndex}`);
                
                categoryData.operations.forEach((op, opIndex) => {
                    const opDiv = document.createElement('div');
                    opDiv.className = 'library-operation';
                    opDiv.id = `op-${categoryIndex}-${opIndex}`;
                    opDiv.onclick = (e) => {
                        if (e.target.type !== 'checkbox') {
                            const checkbox = opDiv.querySelector('.operation-checkbox');
                            checkbox.checked = !checkbox.checked;
                            toggleOperationSelection(categoryIndex, opIndex, checkbox.checked, op);
                        }
                    };
                    
                    const typeText = op.types.includes('all') ? 'All Types' : op.types.join(', ');
                    
                    opDiv.innerHTML = `
                        <input type="checkbox" class="operation-checkbox" id="checkbox-${categoryIndex}-${opIndex}" 
                               onclick="event.stopPropagation()" onchange="toggleOperationSelection(${categoryIndex}, ${opIndex}, this.checked, ${JSON.stringify(op).replace(/"/g, '&quot;')})">
                        <div class="operation-content">
                            <div class="operation-name">${op.name}</div>
                            <span class="operation-type ${categoryData.type}">${typeText}</span>
                            <div class="operation-details">
                                <div class="detail-item">
                                    <div class="detail-value">${op.cycleTime} min</div>
                                    <div class="detail-label">Cycle</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-value">${op.allowance}%</div>
                                    <div class="detail-label">Allowance</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-value">${op.targetEff}%</div>
                                    <div class="detail-label">TARGET EFF</div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    grid.appendChild(opDiv);
                });
                
                library.appendChild(section);
                categoryIndex++;
            }
            
            document.getElementById('operationsLibraryModal').style.display = 'flex';
        }

        function hideOperationsLibrary() {
            document.getElementById('operationsLibraryModal').style.display = 'none';
            selectedOperations.clear();
        }

        function toggleOperationSelection(categoryIndex, opIndex, isChecked, operationData) {
            const opId = `${categoryIndex}-${opIndex}`;
            const checkbox = document.getElementById(`checkbox-${categoryIndex}-${opIndex}`);
            const opDiv = document.getElementById(`op-${categoryIndex}-${opIndex}`);
            
            if (isChecked) {
                selectedOperations.set(opId, operationData);
                opDiv.classList.add('selected');
            } else {
                selectedOperations.delete(opId);
                opDiv.classList.remove('selected');
            }
            
            updateSelectedCount();
            updateCategorySelectAll(categoryIndex);
        }

        function toggleCategorySelection(categoryIndex) {
            const checkbox = document.getElementById(`select-all-${categoryIndex}`);
            const grid = document.getElementById(`operations-grid-${categoryIndex}`);
            const checkboxes = grid.querySelectorAll('.operation-checkbox');
            const isChecked = checkbox.checked;
            
            const categoryName = Object.keys(operationsLibrary)[categoryIndex];
            const categoryData = operationsLibrary[categoryName];
            
            checkboxes.forEach((cb, index) => {
                cb.checked = isChecked;
                const opDiv = document.getElementById(`op-${categoryIndex}-${index}`);
                
                if (isChecked) {
                    const operation = categoryData.operations[index];
                    selectedOperations.set(`${categoryIndex}-${index}`, operation);
                    opDiv.classList.add('selected');
                } else {
                    selectedOperations.delete(`${categoryIndex}-${index}`);
                    opDiv.classList.remove('selected');
                }
            });
            
            updateSelectedCount();
        }

        function updateCategorySelectAll(categoryIndex) {
            const grid = document.getElementById(`operations-grid-${categoryIndex}`);
            const checkboxes = grid.querySelectorAll('.operation-checkbox');
            const selectAll = document.getElementById(`select-all-${categoryIndex}`);
            
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            selectAll.checked = allChecked;
        }

        function clearAllSelections() {
            selectedOperations.clear();
            document.querySelectorAll('.operation-checkbox').forEach(cb => cb.checked = false);
            document.querySelectorAll('.library-operation').forEach(op => op.classList.remove('selected'));
            document.querySelectorAll('[id^="select-all-"]').forEach(cb => cb.checked = false);
            updateSelectedCount();
        }

        function updateSelectedCount() {
            document.getElementById('selectedCount').textContent = 
                `${selectedOperations.size} operation${selectedOperations.size !== 1 ? 's' : ''} selected`;
        }

        function addSelectedOperations() {
            if (selectedOperations.size === 0) {
                showModal("No Selection", "Please select at least one operation.");
                return;
            }
            
            let addedCount = 0;
            
            selectedOperations.forEach((operation, opId) => {
                if (operation && operation.name) {
                    addOperation(
                        operation.name, 
                        operation.cycleTime, 
                        operation.unit || 'minutes', 
                        operation.rating || 100, 
                        operation.allowance || 20,
                        operation.targetEff || 70,
                        operation.machineType || 'SNLS'
                    );
                    addedCount++;
                }
            });
            
            hideOperationsLibrary();
            showModal("Added", `Successfully added ${addedCount} operation${addedCount !== 1 ? 's' : ''} to your garment.`);
            
            setTimeout(calculateAllOperations, 100);
        }

        function filterOperations() {
            const searchTerm = document.getElementById('operationSearch').value.toLowerCase();
            document.querySelectorAll('.library-operation').forEach(op => {
                const name = op.querySelector('.operation-name').textContent.toLowerCase();
                op.style.display = name.includes(searchTerm) ? 'flex' : 'none';
            });
        }

        function filterByGarmentType() {
            const filter = document.getElementById('garmentFilter').value;
            document.querySelectorAll('.library-operation').forEach(op => {
                const typeText = op.querySelector('.operation-type').textContent.toLowerCase();
                const show = filter === 'all' || typeText.includes(filter);
                op.style.display = show ? 'flex' : 'none';
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateDropdownWithSavedGarments();
            
            setGarmentType('T-Shirt');
            
            garmentPresets['T-Shirt'].forEach(op => {
                addOperation(op.name, op.cycleTime, op.unit, op.rating, op.allowance, op.targetEff, op.machineType);
            });
            
            calculateAllOperationsSilently();
            hasInitialized = true;
            
            document.getElementById('shift-time').addEventListener('input', calculateAllOperations);
            document.getElementById('total-operators').addEventListener('input', calculateAllOperations);
            
            document.addEventListener('input', function(e) {
                if (e.target.id && e.target.id.match(/op\d+-(cycle|unit|rating|allowance|target-eff|machine-type)/)) {
                    const opId = e.target.id.match(/op(\d+)-/)[1];
                    if (e.target.id.match(/op\d+-(cycle|unit|rating|allowance)/)) {
                        calculateSAM(opId);
                    }
                    calculateAllOperations();
                }
            });
            
            document.getElementById('garment-type-select').addEventListener('change', function() {
                currentGarmentType = this.value;
            });
            
            const tooltipIcons = document.querySelectorAll('.tooltip-icon');
            
            tooltipIcons.forEach(icon => {
                icon.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    tooltipIcons.forEach(otherIcon => {
                        if (otherIcon !== this) {
                            otherIcon.classList.remove('active');
                        }
                    });
                    
                    this.classList.toggle('active');
                    
                    const closeTooltip = (event) => {
                        if (!this.contains(event.target)) {
                            this.classList.remove('active');
                            document.removeEventListener('touchstart', closeTooltip);
                        }
                    };
                    
                    setTimeout(() => {
                        document.addEventListener('touchstart', closeTooltip);
                    }, 10);
                });
                
                icon.addEventListener('mouseenter', function() {
                    if (window.innerWidth > 768) {
                        this.classList.add('active');
                    }
                });
                
                icon.addEventListener('mouseleave', function() {
                    if (window.innerWidth > 768) {
                        this.classList.remove('active');
                    }
                });
                
                icon.addEventListener('focus', function() {
                    this.classList.add('active');
                });
                
                icon.addEventListener('blur', function() {
                    this.classList.remove('active');
                });
            });
            
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.tooltip-icon')) {
                    document.querySelectorAll('.tooltip-icon').forEach(icon => {
                        icon.classList.remove('active');
                    });
                }
            });
        });
    </script>
</body>
</html>